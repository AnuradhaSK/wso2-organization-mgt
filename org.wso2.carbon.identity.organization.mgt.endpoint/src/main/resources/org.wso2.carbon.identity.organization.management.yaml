# Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

swagger: '2.0'
######################################################
# Prolog
######################################################
info:
  version: "1.0.0"
  title: "WSO2 Identity Server Organization Management Rest API"
  description: |
    This document specifies a **Organization Management RESTful API** for WSO2 **Identity Server** .
    It is written with [swagger 2](http://swagger.io/).
  contact:
    name: "WSO2"
    url: "http://wso2.com/products/identity-server/"
    email: "architecture@wso2.com"
  license:
    name: "Apache 2.0"
    url: "http://www.apache.org/licenses/LICENSE-2.0.html"

######################################################
# The fixed parts of the URLs of the API
######################################################

# The schemes supported by the API
schemes:
  - https

# The domain of the API.
# This is configured by the customer during deployment.
# The given host is just an example.
# host: apis.is.com

# The base path of the API.
# Will be prefixed to all paths.
# if the tenant domain is carbon.super base path can be /api/identity/organization-mgt/v1.0 like this too.

basePath: /t/{tenant-domain}/api/identity/organization-mgt/v1.0

# The following media types can be passed as input in message bodies of the API.
# The actual media type must be specified in the Content-Type header field of the request.
# The default is json, i.e. the Content-Type header is not needed to
# be set, but supporting it serves extensibility.
consumes:
  - application/json

# The following media types may be passed as output in message bodies of the API.
# The media type(s) consumable by the requester is specified in the Accept header field
# of the corresponding request.
# The actual media type returned will be specified in the Content-Type header field
# of the of the response.
# The default of the Accept header is json, i.e. there is not needed to
# set the value, but supporting it serves extensibility.
produces:
  - application/json

paths:
  # Endpoint for organization metadata management
  "/organizations":
    post:
      description: |
        This API is used to create the organization defined in the user input.
      x-wso2-request: |
        curl -X POST "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations" -H "accept: application/json" -H "Content-Type: application/json" -d '{"name": "Phoenix", "description": "Phoenix organization", "attributes": [{"key": "legacy", "value": "true"}], "userstoreConfigs": [{"key": "RDN", "value": "phoenix"}, {"key": "USER_STORE_DOMAIN", "value": "CUSTOMER_USER_STORE"}]}' -k
      x-wso2-curl: |
        curl -X POST "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations" -H "accept: application/json" -H "Content-Type: application/json" -d '{"name": "Phoenix", "description": "Phoenix organization", "attributes": [{"key": "legacy", "value": "true"}], "userstoreConfigs": [{"key": "RDN", "value": "phoenix"}, {"key": "USER_STORE_DOMAIN", "value": "CUSTOMER_USER_STORE"}]}' -k
      x-wso2-response: |
        {"id":"c5ff5889-8c1b-4699-a0c8-a401db589823","name":"Phoenix","description":"Phoenix organization","parentId":"ROOT","active":true,"lastModified":"2020-08-10T18:33:03.635Z","created":"2020-08-10T18:33:03.635Z"}
      summary: |
        Create a new organization.
      # post parameters:
      parameters:
        - name: organization
          in: body
          description: This represents the organization to be added.
          required: true
          schema:
            $ref: '#/definitions/OrganizationAdd'
      responses:
        201:
          description: Successful Response
          schema:
            $ref: '#/definitions/BasicOrganization'
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        409:
          description: Conflict
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
    get:
      description: |
        This API is used to search and retrieve organizations created for this tenant which matches the defined search criteria, if any.
      x-wso2-request: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations?offset=0&limit=2&sortBy=name&sortOrder=DESC" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-curl: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations?offset=0&limit=2&sortBy=name&sortOrder=DESC" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-response: |
        [{"id":"c5ff5889-8c1b-4699-a0c8-a401db589823","name":"Phoenix","description":"Phoenix organization","parentId":"ROOT","active":true,"lastModified":"2020-08-10T18:33:03.635Z","created":"2020-08-10T18:33:03.635Z"}, {"id":"d5ff5889-8c1b-4699-a0c8-a401db589824","name":"Genesis","description":"Genesis organization","parentId":"c5ff5889-8c1b-4699-a0c8-a401db589823","active":true,"lastModified":"2020-08-10T18:33:03.635Z","created":"2020-08-10T18:33:03.635Z"}]
      summary: |
        Retrieve organizations created for this tenant which matches the defined search criteria, if any.
      parameters:
        - in: query
          name: offset
          type: integer
          description: Number of items to be skipped before starting to collect the result set.
        - in: query
          name: limit
          type: integer
          description: Max number of items to be returned.
        - in: query
          name: sortBy
          type: string
          description: Criteria to sort by. (name, lastModified, created)
        - in: query
          name: sortOrder
          type: string
          description: Ascending or Descending order. (ASC, DESC)
      responses:
        200:
          description: Ok
          schema:
            type: array
            items:
              $ref: '#/definitions/BasicOrganization'
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
  "/organizations/{organization-id}":
    get:
      description: |
        This API is used to get an existing organization identified by the organization Id.
      x-wso2-request: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-curl: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-response: |
        {"id":"c5ff5889-8c1b-4699-a0c8-a401db589823","name":"Phoenix","description":"Phoenix organization","parentId":"ROOT","active":true,"lastModified":"2020-08-11 00:03:03.635","created":"2020-08-11 00:03:03.635","attributes":[{"key":"legacy","value":"true"}]}
      summary: |
        Get an existing organization identified by the organization Id.
      parameters:
        - name: organization-id
          in: path
          description: ID of the organization of which, the fields are to be patched.
          required: true
          type: string
      responses:
        200:
          description: Ok
          schema:
            $ref: '#/definitions/Organization'
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        409:
          description: Conflict
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
    patch:
      description: |
        This API is used to add, delete or update the defined field of the organization identified by the organization Id.
      x-wso2-request: |
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"add", "path":"/attributes", "value":{"key":"legacy", "value":"true"}}]'
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"remove", "path":"/attributes/legacy"}, {"op":"remove", "path":"/attributes/onboarded"}]'
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"replace", "path":"/attributes/legacy", "value":{"key":"legacy", "value":"false"}}]'
      x-wso2-curl: |
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"add", "path":"/attributes", "value":{"key":"legacy", "value":"true"}}]'
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"remove", "path":"/attributes/legacy"}, {"op":"remove", "path":"/attributes/onboarded"}]'
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"replace", "path":"/attributes/legacy", "value":{"key":"legacy", "value":"false"}}]'
      x-wso2-response: |
        {}
      summary: |
        This API is used to patch an existing organization, identified by the organization Id.
      parameters:
        - name: organization-id
          in: path
          description:  Id of the organization to be patched.
          required: true
          type: 'string'
        - name: Operations
          in: body
          description:  This represents the patch operation.
          required: true
          schema:
            type: array
            items:
              $ref: '#/definitions/Operation'
      responses:
        204:
          description: Ok
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
    delete:
      description: |
        This API is used to delete an organization, identified by the organization ID.
      x-wso2-request: |
        curl -X DELETE "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-curl: |
        curl -X DELETE "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-response: |
        {}
      summary: |
        Delete an organization by ID.
      parameters:
        - name: organization-id
          in: path
          description: ID of the organization to be deleted.
          required: true
          type: string
      responses:
        204:
          description: Ok
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        409:
          description: Conflict
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
  "/organizations/{organization-id}/userstore-configs":
    get:
      description: |
        This API is used to retrieve user store configurations of an organization identified by the organization Id.
      x-wso2-request: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/userstore-configs" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-curl: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/userstore-configs" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-response: |
        [{"key":"USER_STORE_DOMAIN","value":"CUSTOMER_USER_STORE"},{"key":"DN","value":"phoenix,ou=Users,dc=wso2,dc=org"},{"key":"RDN","value":"phoenix"}]
      summary: |
        Get user store configurations of an organization identified by the organization Id.
      parameters:
        - name: organization-id
          in: path
          description: ID of the organization of which, the user store configurations are to be retrieved.
          required: true
          type: string
      responses:
        200:
          description: Ok
          schema:
            type: array
            items:
              $ref: '#/definitions/UserstoreConfig'
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        409:
          description: Conflict
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
    patch:
      description: |
        This API is used to patch user store configurations of an organization, identified by the organization Id.
      x-wso2-request: |
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/userstore-configs" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"add", "path":"/RDN", "value":{"key":"RDN", "value":"pheonix"}}]'
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/userstore-configs" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"replace", "path":"/RDN", "value":{"key":"RDN", "value":"genesis"}}]'
      x-wso2-curl: |
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/userstore-configs" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"add", "path":"/RDN", "value":{"key":"RDN", "value":"pheonix"}}]'
        curl -X PATCH "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/userstore-configs" -H "accept: application/json" -H "Content-Type: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -d '[{"op":"replace", "path":"/RDN", "value":{"key":"RDN", "value":"genesis"}}]'
      x-wso2-response: |
        {}
      summary: |
        Patch user store configurations of an organization identified by the organization Id.
      parameters:
        - name: organization-id
          in: path
          description: ID of the organization of which, the user store configurations are to be patched.
          required: true
          type: string
        - name: Operations
          in: body
          description:  This represents the patch operation.
          required: true
          schema:
            type: array
            items:
              $ref: '#/definitions/Operation'
      responses:
        204:
          description: Ok
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        409:
          description: Conflict
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
  "/organizations/{organization-id}/children":
    get:
      description: |
        This API is used to retrieve children of an organization identified by the organization Id.
      x-wso2-request: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/children" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-curl: |
        curl -X GET "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations/c5ff5889-8c1b-4699-a0c8-a401db589823/children" -H "accept: application/json" -H 'Authorization: Basic YWRtaW46YWRtaW4=' -k
      x-wso2-response: |
        ["a5ff5889-8c1b-4699-a0c8-a401db589823","b5ff5889-8c1b-4699-a0c8-a401db589824","c5ff5889-8c1b-4699-a0c8-a401db589825"]
      summary: |
        Get a list of child organization IDs for a given organization.
      parameters:
        - name: organization-id
          in: path
          description: ID of the organization of which, the children are to be retrieved.
          required: true
          type: string
      responses:
        200:
          description: Ok
          schema:
            type: array
            items:
              type: string
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        409:
          description: Conflict
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization
  "/organizations/import":
    post:
      description: |
        This API is used to create an organization to represent an exisitng organization of the underlying user store. Hence, this will not create any OU in the LDAP.
      x-wso2-request: |
        curl -X POST "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations" -H "accept: application/json" -H "Content-Type: application/json" -d '{"name": "Phoenix", "description": "Phoenix organization", "attributes": [{"key": "legacy", "value": "true"}], "userstoreConfigs": [{"key": "RDN", "value": "phoenix"}, {"key": "USER_STORE_DOMAIN", "value": "CUSTOMER_USER_STORE"}]}' -k
      x-wso2-curl: |
        curl -X POST "https://localhost:9443/api/identity/organization-mgt/v1.0/organizations" -H "accept: application/json" -H "Content-Type: application/json" -d '{"name": "Phoenix", "description": "Phoenix organization", "attributes": [{"key": "legacy", "value": "true"}], "userstoreConfigs": [{"key": "RDN", "value": "phoenix"}, {"key": "USER_STORE_DOMAIN", "value": "CUSTOMER_USER_STORE"}]}' -k
      x-wso2-response: |
        {"id":"c5ff5889-8c1b-4699-a0c8-a401db589823","name":"Phoenix","description":"Phoenix organization","parentId":"ROOT","active":true,"lastModified":"2020-08-10T18:33:03.635Z","created":"2020-08-10T18:33:03.635Z"}
      summary: |
        Create an organization without changing the underlying LDAP.
      # post parameters:
      parameters:
        - name: organization
          in: body
          description: This represents the organization to be added.
          required: true
          schema:
            $ref: '#/definitions/OrganizationAdd'
      responses:
        201:
          description: Successful Response
          schema:
            $ref: '#/definitions/BasicOrganization'
        400:
          description: Bad Request
          schema:
            $ref: '#/definitions/Error'
        401:
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        409:
          description: Conflict
          schema:
            $ref: '#/definitions/Error'
        500:
          description: Server Error
          schema:
            $ref: '#/definitions/Error'
      tags:
        - Organization

definitions:
  #-----------------------------------------------------
  # OrganizationAdd Object
  #-----------------------------------------------------
  OrganizationAdd:
    type: object
    required:
      - name
    properties:
      name:
        type: string
      description:
        type: string
      parentId:
        type: string
      attributes:
        type: array
        items:
          $ref: '#/definitions/Attribute'
      userstoreConfigs:
        type: array
        items:
          $ref: '#/definitions/UserstoreConfig'
  #-----------------------------------------------------
  # BasicOrganization Object
  #-----------------------------------------------------
  BasicOrganization:
    type: object
    required:
      - id
      - name
      - parentId
      - active
      - lastModified
      - created
    properties:
      id:
        type: string
      name:
        type: string
      description:
        type: string
      parentId:
        type: string
      active:
        type: boolean
      lastModified:
        type: string
      created:
        type: string
  #-----------------------------------------------------
  # Organization Object
  #-----------------------------------------------------
  Organization:
    type: object
    required:
      - id
      - name
      - parentId
      - active
      - lastModified
      - created
    properties:
      id:
        type: string
      name:
        type: string
      description:
        type: string
      parentId:
        type: string
      active:
        type: boolean
      lastModified:
        type: string
      created:
        type: string
      attributes:
        type: array
        items:
          $ref: '#/definitions/Attribute'
  #-----------------------------------------------------
  # Organization Attribute Object
  #-----------------------------------------------------
  Attribute:
    type: object
    required:
      - key
      - value
    properties:
      key:
        type: string
      value:
        type: string
  #-----------------------------------------------------
  # Organization UserstoreConfig Object
  #-----------------------------------------------------
  UserstoreConfig:
    type: object
    required:
      - key
      - value
    properties:
      key:
        type: string
      value:
        type: string
  #-----------------------------------------------------
  # Organization Patch Operation Object
  #-----------------------------------------------------
  Operation:
    type: object
    required:
      - op
      - path
      - value
    properties:
      op:
        type: string
      path:
        type: string
      value:
        type: string
  #-----------------------------------------------------
  # Error Response  object
  #-----------------------------------------------------
  Error:
    type: object
    properties:
      code:
        type: string
      message:
        type: string
      description:
        type: string
